name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - "apps/backend/**"
      - "src/**"
      - "package.json"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm ci

      - name: Build backend
        run: |
          cd apps/backend
          npm run build

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          # Create deployment directory if it doesn't exist
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /var/www/alpha-ai/backend"

          # Copy backend files to server
          scp -r apps/backend/dist/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/alpha-ai/backend/
          scp -r apps/backend/node_modules ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/alpha-ai/backend/
          cp apps/backend/package.json ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/alpha-ai/backend/

          # Set proper permissions
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "chown -R www-data:www-data /var/www/alpha-ai/backend && chmod -R 755 /var/www/alpha-ai/backend"

      - name: Setup PM2 and start backend
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # Install PM2 globally if not installed
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi

          # Navigate to backend directory
          cd /var/www/alpha-ai/backend

          # Install dependencies
          npm ci --production

          # Start/restart the application with PM2
          pm2 restart alpha-ai-backend || pm2 start dist/main.js --name alpha-ai-backend

          # Save PM2 configuration
          pm2 save

          # Setup PM2 startup script
          pm2 startup
          "

      - name: Setup firewall (if needed)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # Allow necessary ports
          ufw allow 22
          ufw allow 80
          ufw allow 443
          ufw allow 3001

          # Enable firewall if not already enabled
          if ! ufw status | grep -q 'Status: active'; then
            ufw --force enable
          fi
          "
