name: Setup Server

on:
  workflow_dispatch:
    inputs:
      setup_nginx:
        description: 'Setup Nginx'
        required: false
        default: 'true'
      setup_node:
        description: 'Setup Node.js'
        required: false
        default: 'true'
      setup_pm2:
        description: 'Setup PM2'
        required: false
        default: 'true'

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Update system and install dependencies
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        apt update && apt upgrade -y
        apt install -y curl wget git nginx ufw software-properties-common
        
        # Add NodeSource repository
        if [ '${{ github.event.inputs.setup_node }}' = 'true' ]; then
          curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
          apt-get install -y nodejs
        fi
        
        # Install PM2
        if [ '${{ github.event.inputs.setup_pm2 }}' = 'true' ]; then
          npm install -g pm2
        fi
        "
        
    - name: Setup directories
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        mkdir -p /var/www/alpha-ai/{frontend,backend,logs}
        chown -R www-data:www-data /var/www/alpha-ai
        "
        
    - name: Setup Nginx
      if: github.event.inputs.setup_nginx == 'true'
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        # Remove default site
        rm -f /etc/nginx/sites-enabled/default
        
        # Create main site configuration
        cat > /etc/nginx/sites-available/alpha-ai << 'EOF'
server {
    listen 80;
    server_name _;
    
    # Frontend
    location / {
        root /var/www/alpha-ai/frontend;
        index index.html;
        try_files \$uri \$uri/ /index.html;
    }
    
    # Backend API
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
    
    # Security headers
    add_header X-Frame-Options \"SAMEORIGIN\" always;
    add_header X-XSS-Protection \"1; mode=block\" always;
    add_header X-Content-Type-Options \"nosniff\" always;
    add_header Referrer-Policy \"no-referrer-when-downgrade\" always;
    add_header Content-Security-Policy \"default-src 'self' http: https: data: blob: 'unsafe-inline'\" always;
}
EOF
        
        # Enable site
        ln -sf /etc/nginx/sites-available/alpha-ai /etc/nginx/sites-enabled/
        
        # Test and reload Nginx
        nginx -t && systemctl reload nginx
        systemctl enable nginx
        "
        
    - name: Setup firewall
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        # Configure firewall
        ufw allow 22/tcp
        ufw allow 80/tcp
        ufw allow 443/tcp
        ufw allow 3001/tcp
        
        # Enable firewall
        ufw --force enable
        
        # Start services
        systemctl start nginx
        systemctl enable nginx
        "
