name: Deploy Qatar One Platform

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - "apps/backend/**"
      - "src/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Build Frontend
      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.qatar-one.app

      # Build Backend
      - name: Build Backend
        run: |
          cd apps/backend
          npm ci
          npm run build

      # Create deployment archives
      - name: Create deployment archives
        run: |
          # Frontend archive
          if [ -d "frontend/out" ]; then
            cd frontend/out
            tar -czf ../../frontend-deploy.tar.gz .
            cd ../..
          else
            echo "Error: frontend/out directory not found"
            ls -la frontend/
            exit 1
          fi

          # Backend archive
          if [ -d "apps/backend/dist" ]; then
            cd apps/backend
            tar -czf ../../backend-deploy.tar.gz dist package.json package-lock.json prisma
            cd ../..
          else
            echo "Error: apps/backend/dist directory not found"
            ls -la apps/backend/
            exit 1
          fi

      # Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # Deploy to server
      - name: Deploy to server
        run: |
          # Transfer archives
          scp -i ~/.ssh/deploy_key frontend-deploy.tar.gz root@${{ secrets.SERVER_HOST }}:/tmp/
          scp -i ~/.ssh/deploy_key backend-deploy.tar.gz root@${{ secrets.SERVER_HOST }}:/tmp/

          # Deploy on server
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸš€ DÃ©ploiement Qatar One Platform"
            
            # Deploy Frontend
            echo "ðŸ“¦ DÃ©ploiement Frontend..."
            mkdir -p /var/www/qatar-one/frontend
            cd /var/www/qatar-one/frontend
            tar -xzf /tmp/frontend-deploy.tar.gz
            chown -R www-data:www-data /var/www/qatar-one/frontend
            echo "âœ… Frontend dÃ©ployÃ©"
            
            # Deploy Backend
            echo "ðŸ“¦ DÃ©ploiement Backend..."
            mkdir -p /var/www/qatar-one/backend
            cd /var/www/qatar-one/backend
            tar -xzf /tmp/backend-deploy.tar.gz
            
            # Install production dependencies
            npm ci --production
            
            # Generate Prisma Client
            npx prisma generate
            
            # Apply database migrations
            npx prisma db push --accept-data-loss || echo "âš ï¸ Migrations dÃ©jÃ  appliquÃ©es"
            
            # Restart backend with PM2
            pm2 restart qatar-one-backend || pm2 start dist/main.js --name qatar-one-backend
            pm2 save
            
            echo "âœ… Backend dÃ©ployÃ© et redÃ©marrÃ©"
            
            # Cleanup
            rm -f /tmp/frontend-deploy.tar.gz /tmp/backend-deploy.tar.gz
            
            echo "ðŸŽ‰ DÃ©ploiement terminÃ© avec succÃ¨s!"
            
            # Show status
            pm2 status
          ENDSSH

      # Verify deployment
      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            echo "ðŸ” VÃ©rification du dÃ©ploiement..."
            
            # Check backend health
            sleep 3
            curl -f http://localhost:3001/health || exit 1
            
            echo "âœ… Backend opÃ©rationnel"
            
            # Check PM2 status
            pm2 list
          ENDSSH

      # Cleanup SSH key
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      # Notification
      - name: Deployment notification
        if: success()
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi sur https://qatar-one.app"
          echo "ðŸ“Š Backend: https://api.qatar-one.app"
          echo "ðŸ” Auth: https://qatar-one.app/auth"
