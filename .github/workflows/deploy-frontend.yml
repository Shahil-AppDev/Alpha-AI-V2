name: Deploy Frontend

on:
    push:
        branches: [main]
        paths:
            - "frontend/**"
            - ".github/workflows/deploy-frontend.yml"
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              run: |
                  cd frontend
                  npm ci

            - name: Build frontend
              run: |
                  cd frontend
                  npm run build

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add server to known hosts
              run: |
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy to server
              run: |
                  # Create deployment directory if it doesn't exist
                  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /var/www/alpha-ai/frontend"

                  # Copy built files to server
                  scp -r frontend/out/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/alpha-ai/frontend/

                  # Set proper permissions
                  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "chown -R www-data:www-data /var/www/alpha-ai/frontend && chmod -R 755 /var/www/alpha-ai/frontend"

            - name: Configure Nginx (if needed)
              run: |
                  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
                  # Create nginx config if it doesnt exist
                  if [ ! -f /etc/nginx/sites-available/alpha-ai ]; then
                    cat > /etc/nginx/sites-available/alpha-ai << "EOF"
                  server {
                      listen 80;
                      server_name _;
                      root /var/www/alpha-ai/frontend;
                      index index.html;
                      
                      location / {
                          try_files \$uri \$uri/ /index.html;
                      }
                      
                      location /api {
                          proxy_pass http://localhost:3001;
                          proxy_http_version 1.1;
                          proxy_set_header Upgrade \$http_upgrade;
                          proxy_set_header Connection "upgrade";
                          proxy_set_header Host \$host;
                          proxy_set_header X-Real-IP \$remote_addr;
                          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                          proxy_set_header X-Forwarded-Proto \$scheme;
                          proxy_cache_bypass \$http_upgrade;
                      }
                  }
                  EOF
                    
                    # Enable site
                    ln -sf /etc/nginx/sites-available/alpha-ai /etc/nginx/sites-enabled/
                    nginx -t && systemctl reload nginx
                  fi
                  '
