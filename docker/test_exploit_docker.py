#!/usr/bin/env python3

import sys
sys.path.append('/app/src')

from modules.exploit_module import generate_reverse_shell_payload, adapt_exploit_template
from tool_manager import ToolManager

def test_exploit_docker():
    print('=== Testing Exploit Module in Docker ===')

    # Test ToolManager integration
    tool_manager = ToolManager()
    print(f'ToolManager tools: {list(tool_manager.tools.keys())}')

    # Test reverse shell generation
    result1 = generate_reverse_shell_payload('192.168.1.100', 4444, 'python')
    print(f'Reverse shell generation: {result1["success"]}')
    if result1["success"]:
        print(f'Payload length: {result1["length"]} bytes')
        print(f'Language: {result1["language"]}')

    # Test template adaptation
    import tempfile
    import os

    # Create a test template
    template_content = '''
TARGET_IP = "{{TARGET_IP}}"
TARGET_PORT = {{TARGET_PORT}}
VERSION = "{{VERSION}}"
'''

    with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
        f.write(template_content)
        template_path = f.name

    target_info = {'ip': '192.168.1.100', 'port': 8080, 'version': '2.3.1'}
    result2 = adapt_exploit_template(template_path, target_info)
    print(f'Template adaptation: {result2["success"]}')
    if result2["success"]:
        print(f'Placeholders filled: {result2["placeholders_filled"]}')
        print(f'Adapted code length: {result2["length"]} bytes')

    # Clean up
    os.unlink(template_path)

    print('=== Docker Exploit Module Test Complete ===')

if __name__ == "__main__":
    test_exploit_docker()
